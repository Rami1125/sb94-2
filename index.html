
<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול נהגים - Dashboard</title>
    <!-- Use Tailwind CSS for a professional, modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', // A deep purple for branding
                        secondary: '#8B5CF6', // A lighter purple
                        accent: '#FACC15', // A golden yellow for accents
                        background: '#F9FAFB', // Light gray background
                    },
                }
            }
        }
    </script>
    <style>
        body {
            direction: rtl; /* Right-to-left for Hebrew */
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }
        .container-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Custom scrollbar for visual appeal */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Main Dashboard Section -->
        <div id="main-dashboard-section">
            <header class="text-center mb-12">
                <h1 class="text-4xl font-extrabold text-primary">מערכת ניהול נהגים - Dashboard</h1>
                <p class="mt-2 text-lg text-gray-600">ניהול סידורים בזמן אמת עבור עלי וחכמת</p>
            </header>

            <!-- Loading Indicator -->
            <div id="loading" class="flex items-center justify-center space-x-2 text-gray-500 mb-6">
                <svg class="animate-spin h-5 w-5 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>טוען נתונים...</span>
            </div>

            <!-- Dashboard Section - Cards -->
            <section id="dashboard-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <!-- Total Orders Card -->
                <div class="bg-white rounded-xl p-6 container-shadow transition-transform transform hover:scale-105">
                    <h3 class="text-gray-500 text-sm font-medium">סה"כ הזמנות</h3>
                    <p id="totalOrders" class="mt-1 text-3xl font-semibold text-gray-900">-</p>
                </div>
                <!-- Ali's Orders Card -->
                <div onclick="showDriverPage('עלי')" class="bg-white rounded-xl p-6 container-shadow transition-transform transform hover:scale-105 cursor-pointer">
                    <h3 class="text-gray-500 text-sm font-medium">סידורים של עלי</h3>
                    <p id="aliOrders" class="mt-1 text-3xl font-semibold text-gray-900">-</p>
                </div>
                <!-- Hakmat's Orders Card -->
                <div onclick="showDriverPage('חכמת')" class="bg-white rounded-xl p-6 container-shadow transition-transform transform hover:scale-105 cursor-pointer">
                    <h3 class="text-gray-500 text-sm font-medium">סידורים של חכמת</h3>
                    <p id="hakmatOrders" class="mt-1 text-3xl font-semibold text-gray-900">-</p>
                </div>
                <!-- Add New Order Card -->
                <div class="bg-white rounded-xl p-6 container-shadow transition-transform transform hover:scale-105 flex items-center justify-center cursor-pointer bg-primary text-white hover:bg-secondary" onclick="showModal()">
                    <div class="text-center">
                        <svg class="h-8 w-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <p class="mt-2 font-bold text-lg">הוסף הזמנה חדשה</p>
                    </div>
                </div>
            </section>

            <!-- Dynamic Orders Table -->
            <section class="bg-white rounded-xl p-6 container-shadow overflow-x-auto">
                <h2 class="text-2xl font-bold text-primary mb-4">טבלת סידורי עבודה</h2>
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-4 md:space-y-0">
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="חיפוש..." class="w-full md:w-1/3 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                    <select id="driverFilter" onchange="filterTable()" class="w-full md:w-1/4 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">כל הנהגים</option>
                        <option value="עלי">עלי</option>
                        <option value="חכמת">חכמת</option>
                    </select>
                    <select id="statusFilter" onchange="filterTable()" class="w-full md:w-1/4 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">כל הסטטוסים</option>
                        <option value="מתכונן ליציאה">מתכונן ליציאה</option>
                        <option value="בדרך">בדרך</option>
                        <option value="סופק">סופק</option>
                        <option value="נדחה למועד אחר">נדחה למועד אחר</option>
                        <option value="מוכנה">מוכנה</option>
                        <option value="בטיפול">בטיפול</option>
                        <option value="בוטל">בוטל</option>
                    </select>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">נהג</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שעה</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מחסן</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">לקוח</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת אספקה</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סוג פעולה</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be loaded here dynamically from Google Sheets -->
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Driver Profile Section (initially hidden) -->
        <div id="driver-profile-section" class="hidden">
            <header class="text-center mb-8">
                <button onclick="showMainDashboard()" class="mb-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">חזור ללוח המחוונים</button>
                <img id="driver-avatar" class="w-32 h-32 rounded-full mx-auto mb-4 container-shadow object-cover" src="" alt="Driver Profile Picture">
                <h1 id="driver-name" class="text-4xl font-extrabold text-primary"></h1>
                <h2 id="driver-slogan" class="mt-2 text-lg text-gray-600"></h2>
            </header>
            <section class="bg-white rounded-xl p-6 container-shadow overflow-x-auto">
                <h3 class="text-2xl font-bold text-primary mb-4">טבלת הזמנות של <span id="driver-name-in-table"></span></h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">לקוח</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שעה</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מחסן</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת אספקה</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סוג פעולה</th>
                        </tr>
                    </thead>
                    <tbody id="driverOrdersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Specific driver data will be loaded here dynamically -->
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Modal for adding/editing orders -->
        <div id="orderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center">
            <div class="bg-white p-8 rounded-xl container-shadow w-full max-w-lg mx-4">
                <h3 class="text-2xl font-bold mb-4 text-primary">הוסף/ערוך הזמנה</h3>
                <form id="orderForm">
                    <div class="mb-4">
                        <label for="driverName" class="block text-gray-700">שם נהג:</label>
                        <select id="driverName" name="driverName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2">
                            <option value="עלי">עלי</option>
                            <option value="חכמת">חכמת</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="customerName" class="block text-gray-700">שם לקוח:</label>
                        <input type="text" id="customerName" name="customerName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2">
                    </div>
                    <div class="mb-4">
                        <label for="city" class="block text-gray-700">כתובת אספקה:</label>
                        <input type="text" id="city" name="city" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2">
                    </div>
                    <div class="mb-4">
                        <label for="orderType" class="block text-gray-700">סוג פעולה:</label>
                        <select id="orderType" name="orderType" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2">
                            <option value="הובלה אזורי">הובלה אזורי</option>
                            <option value="פריקה ידנית">פריקה ידנית</option>
                            <option value="גישה לאתר">גישה לאתר</option>
                            <option value="הובלת מנוף">הובלת מנוף</option>
                            <option value="הובלת מנוף 15 מטר">הובלת מנוף 15 מטר</option>
                            <option value="איסוף בלות פסולת">איסוף בלות פסולת</option>
                            <option value="עבודת מנוף">עבודת מנוף</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="status" class="block text-gray-700">סטטוס:</label>
                        <select id="status" name="status" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2">
                            <option value="מתכונן ליציאה">מתכונן ליציאה</option>
                            <option value="בדרך">בדרך</option>
                            <option value="סופק">סופק</option>
                            <option value="נדחה למועד אחר">נדחה למועד אחר</option>
                            <option value="מוכנה">מוכנה</option>
                            <option value="בטיפול">בטיפול</option>
                            <option value="בוטל">בוטל</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">שמור</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- The core logic for connecting to Google Sheets and manipulating the DOM -->
    <script>
        // REPLACE 'YOUR_SHEET_ID_HERE' with your actual Google Sheet ID
        const SHEET_ID = 'YOUR_SHEET_ID_HERE';
        const API_KEY = '';
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        const DRIVERS = {
            'עלי': {
                slogan: 'מומחה בהובלות קטנות',
                image: 'https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg'
            },
            'חכמת': {
                slogan: 'הובלות מנוף מורכבות',
                image: 'https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg'
            }
        };

        let ordersData = [];

        // Function to fetch data from Google Sheets
        async function fetchOrders() {
            try {
                document.getElementById('loading').style.display = 'flex';
                const response = await fetch(sheetUrl);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                const rows = json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));
                
                // Convert rows array to objects with keys based on the new table structure
                ordersData = rows.slice(1).map(row => ({
                    driverName: row[0],
                    date: row[1],
                    time: row[2],
                    warehouse: row[3],
                    status: row[4],
                    customerName: row[5],
                    address: row[6],
                    orderType: row[7],
                }));

                console.log('Fetched data:', ordersData);
                renderTable(ordersData, 'ordersTableBody');
                updateDashboard(ordersData);
            } catch (error) {
                console.error('Failed to fetch data:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Function to render the table with the data
        function renderTable(data, tableId) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    ${tableId === 'ordersTableBody' ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.driverName}</td>` : ''}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.time}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.warehouse}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(item.status)}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.customerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.orderType}</td>
                    ${tableId === 'ordersTableBody' ? `<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editOrder('${item.orderId}')" class="text-indigo-600 hover:text-indigo-900 ml-2">ערוך</button>
                        <button onclick="deleteOrder('${item.orderId}')" class="text-red-600 hover:text-red-900">מחק</button>
                    </td>` : ''}
                `;
                tableBody.appendChild(row);
            });
        }

        // Helper function for status colors
        function getStatusColor(status) {
            switch(status) {
                case 'מתכונן ליציאה': return 'bg-blue-100 text-blue-800';
                case 'בדרך': return 'bg-yellow-100 text-yellow-800';
                case 'סופק': return 'bg-green-100 text-green-800';
                case 'נדחה למועד אחר': return 'bg-red-100 text-red-800';
                case 'מוכנה': return 'bg-purple-100 text-purple-800';
                case 'בטיפול': return 'bg-gray-100 text-gray-800';
                case 'בוטל': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Function to update the dashboard cards
        function updateDashboard(data) {
            const totalOrders = data.length;
            const aliOrders = data.filter(item => item.driverName === 'עלי').length;
            const hakmatOrders = data.filter(item => item.driverName === 'חכמת').length;

            document.getElementById('totalOrders').innerText = totalOrders;
            document.getElementById('aliOrders').innerText = aliOrders;
            document.getElementById('hakmatOrders').innerText = hakmatOrders;
        }

        // Function to filter the table based on search and dropdowns
        function filterTable() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const driverFilter = document.getElementById('driverFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredData = ordersData.filter(item => {
                const searchMatch = Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchText)
                );
                const driverMatch = driverFilter === '' || item.driverName === driverFilter;
                const statusMatch = statusFilter === '' || item.status === statusFilter;

                return searchMatch && driverMatch && statusMatch;
            });
            renderTable(filteredData, 'ordersTableBody');
        }

        // Functions to show/hide modal (for adding/editing orders)
        function showModal() {
            document.getElementById('orderModal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        // Functions to switch between views
        function showDriverPage(driverName) {
            document.getElementById('main-dashboard-section').style.display = 'none';
            document.getElementById('driver-profile-section').style.display = 'block';

            const driver = DRIVERS[driverName];
            document.getElementById('driver-avatar').src = driver.image;
            document.getElementById('driver-name').innerText = driverName;
            document.getElementById('driver-name-in-table').innerText = driverName;
            document.getElementById('driver-slogan').innerText = driver.slogan;

            const driverOrders = ordersData.filter(item => item.driverName === driverName);
            renderTable(driverOrders, 'driverOrdersTableBody');
        }

        function showMainDashboard() {
            document.getElementById('driver-profile-section').style.display = 'none';
            document.getElementById('main-dashboard-section').style.display = 'block';
            renderTable(ordersData, 'ordersTableBody');
        }

        // Initial fetch of data when the page loads
        document.addEventListener('DOMContentLoaded', fetchOrders);
    </script>

</body>
</html>
